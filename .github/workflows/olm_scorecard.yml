name: Operator Scorecard Test

on: [push, pull_request]

jobs:
  scorecard-check:
    runs-on: ubuntu-latest
    steps:
    - name: Check out code
      uses: actions/checkout@v2
      
    - name: Install Operator SDK
      run: |
        curl -LO https://github.com/operator-framework/operator-sdk/releases/download/v1.24.1/operator-sdk_linux_amd64
        chmod +x operator-sdk_linux_amd64
        sudo mv operator-sdk_linux_amd64 /usr/local/bin/operator-sdk

    - name: Build bundle
      run: make bundle-build

    - name: Install yq
      run: |
        sudo wget -O /usr/bin/yq https://github.com/mikefarah/yq/releases/download/v4.6.1/yq_linux_amd64
        sudo chmod +x /usr/bin/yq

    - name: Modify scorecard config
      run: |
        yq e 'del(.stages[].tests[] | select(.labels.test == "olm-crds-have-resources-test"))' -i bundle/tests/scorecard/config.yaml
        ls -lah 
        ls -lah bundle
        ls -lah bundle/tests
        ls -lah bundle/tests/scorecard/
        
    - name: Run Operator SDK Scorecard
      run: operator-sdk scorecard bundle/tests/scorecard/config.yaml
